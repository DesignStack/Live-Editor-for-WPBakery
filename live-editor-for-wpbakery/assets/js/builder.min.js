/**
 * Live Editor for WPBakery - Builder JavaScript
 * Version: 1.0
 *
 * @package LiveEditorWPBakery
 */

(function($) {
	'use strict';

	/**
	 * Main Live Editor Builder
	 */
	window.$lew = {
		/**
		 * Configuration
		 */
		config: {},

		/**
		 * Initialize the builder
		 */
		init: function() {
			this.loadConfig();
			this.bindEvents();
			this.initPreview();
		},

		/**
		 * Load configuration from data attribute
		 */
		loadConfig: function() {
			var $wrapper = $('#lew-wrapper');
			if ($wrapper.length && $wrapper.attr('data-lew-config')) {
				try {
					this.config = JSON.parse($wrapper.attr('data-lew-config'));
				} catch(e) {
					console.error('Failed to parse LEW config:', e);
				}
			}
		},

		/**
		 * Bind event handlers
		 */
		bindEvents: function() {
			var self = this;

			// Panel switcher
			$('.lew-panel-switcher').on('click', function() {
				$('.lew-panel').toggleClass('hidden');
			});

			// Responsive mode switcher
			$('.lew-preview-mode').on('click', function() {
				var mode = $(this).data('mode');
				self.setPreviewMode(mode);
			});

			// Save button
			$('.lew-save-button').on('click', function() {
				if (!$(this).prop('disabled')) {
					self.saveChanges();
				}
			});

			// Prevent navigation away with unsaved changes
			$(window).on('beforeunload', function() {
				if (self.hasUnsavedChanges()) {
					return window.lewGlobalData.textTranslations.page_leave_warning;
				}
			});
		},

		/**
		 * Initialize preview iframe
		 */
		initPreview: function() {
			var self = this;
			var $iframe = $('#lew-preview-iframe');

			if ($iframe.length) {
				$iframe.on('load', function() {
					self.onPreviewLoaded();
				});
			}
		},

		/**
		 * Set preview mode (responsive)
		 */
		setPreviewMode: function(mode) {
			$('.lew-preview-mode').removeClass('active');
			$('.lew-preview-mode[data-mode="' + mode + '"]').addClass('active');

			var $iframe = $('#lew-preview-iframe');
			var $container = $('.lew-preview-container');

			// Reset container styles
			$container.css('padding', '20px');

			// Apply mode-specific styles
			switch(mode) {
				case 'tablet':
					$iframe.css({
						'max-width': '1024px',
						'margin': '0 auto'
					});
					break;
				case 'mobile':
					$iframe.css({
						'max-width': '768px',
						'margin': '0 auto'
					});
					break;
				default: // desktop
					$iframe.css({
						'max-width': 'none',
						'margin': '0'
					});
			}
		},

		/**
		 * Preview loaded handler
		 */
		onPreviewLoaded: function() {
			console.log('Preview loaded');
			// Additional initialization can go here
		},

		/**
		 * Check if there are unsaved changes
		 */
		hasUnsavedChanges: function() {
			// This would be implemented with actual change tracking
			return false;
		},

		/**
		 * Save changes
		 */
		saveChanges: function() {
			var self = this;
			var $button = $('.lew-save-button');

			// Get iframe document
			var $iframe = $('#lew-preview-iframe');
			if (!$iframe.length) return;

			var iframeDoc = $iframe[0].contentDocument || $iframe[0].contentWindow.document;
			if (!iframeDoc) return;

			// Get content from iframe
			var content = '';
			var $content = $(iframeDoc).find('[data-usbid="container"]');
			if ($content.length) {
				content = $content.html();
			} else {
				content = $(iframeDoc).find('body').html();
			}

			// Get custom CSS if exists
			var customCSS = '';
			var $customCSS = $(iframeDoc).find('style[data-type="lew_post_custom_css"]');
			if ($customCSS.length) {
				customCSS = $customCSS.text();
			}

			$button.prop('disabled', true).text('Saving...');

			// Send AJAX request
			$.ajax({
				url: ajaxurl,
				type: 'POST',
				data: {
					action: 'lew_save_post',
					_nonce: self.config.ajaxArgs._nonce,
					post: self.config.ajaxArgs.post,
					content: content,
					custom_css: customCSS
				},
				success: function(response) {
					if (response.success) {
						self.showNotification('success', window.lewGlobalData.textTranslations.page_updated);
						$button.prop('disabled', true).text('Saved');

						// Re-enable after 2 seconds
						setTimeout(function() {
							$button.prop('disabled', false).text('Save Changes');
						}, 2000);
					} else {
						self.showNotification('error', response.data.message || 'Save failed');
						$button.prop('disabled', false).text('Save Changes');
					}
				},
				error: function() {
					self.showNotification('error', 'Save failed');
					$button.prop('disabled', false).text('Save Changes');
				}
			});
		},

		/**
		 * Show notification
		 */
		showNotification: function(type, message) {
			// Simple console notification for now
			// Can be enhanced with actual UI notifications
			if (type === 'error') {
				console.error(message);
			} else {
				console.log(message);
			}

			// Show WordPress admin notice style notification
			var $notice = $('<div class="notice notice-' + type + ' is-dismissible"><p>' + message + '</p></div>');
			$('.lew-panel-header').prepend($notice);

			setTimeout(function() {
				$notice.fadeOut(function() {
					$(this).remove();
				});
			}, 3000);
		},

		/**
		 * Event trigger utility
		 */
		trigger: function(event, data) {
			$(document).trigger(event, data);
		},

		/**
		 * Event listener utility
		 */
		on: function(event, callback) {
			$(document).on(event, callback);
		}
	};

	/**
	 * Initialize on document ready
	 */
	$(document).ready(function() {
		window.$lew.init();
	});

})(jQuery);

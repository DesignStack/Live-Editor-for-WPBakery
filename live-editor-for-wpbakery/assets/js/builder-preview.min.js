/**
 * Live Editor for WPBakery - Preview JavaScript
 * Version: 1.0
 *
 * @package LiveEditorWPBakery
 */

(function($) {
	'use strict';

	/**
	 * Preview functionality
	 */
	var LEWPreview = {

		/**
		 * Current hovered element
		 */
		$hoveredElement: null,

		/**
		 * Hover highlight element
		 */
		$hoverHighlight: null,

		/**
		 * Initialize preview
		 */
		init: function() {
			this.createHoverHighlight();
			this.bindEvents();
			this.notifyParent();
		},

		/**
		 * Create hover highlight element
		 */
		createHoverHighlight: function() {
			this.$hoverHighlight = $('.lew-hover');
			if (!this.$hoverHighlight.length) {
				this.$hoverHighlight = $('<div class="lew-hover"></div>');
				$('body').append(this.$hoverHighlight);
			}
		},

		/**
		 * Bind event handlers
		 */
		bindEvents: function() {
			var self = this;

			// Hover events on elements with usbid
			$(document).on('mouseenter', '[data-usbid]', function(e) {
				e.stopPropagation();
				self.highlightElement($(this));
			});

			$(document).on('mouseleave', '[data-usbid]', function(e) {
				e.stopPropagation();
				self.removeHighlight();
			});

			// Click events
			$(document).on('click', '[data-usbid]', function(e) {
				e.preventDefault();
				e.stopPropagation();
				self.selectElement($(this));
			});

			// Handle hover panel buttons
			$(document).on('click', '.lew-hover-panel-btn', function(e) {
				e.preventDefault();
				e.stopPropagation();

				var action = '';
				if ($(this).hasClass('ui-icon_copy')) action = 'copy';
				else if ($(this).hasClass('ui-icon_paste')) action = 'paste';
				else if ($(this).hasClass('ui-icon_duplicate')) action = 'duplicate';
				else if ($(this).hasClass('ui-icon_delete')) action = 'delete';

				if (action) {
					self.handleAction(action, self.$hoveredElement);
				}
			});

			// Window resize
			$(window).on('resize', function() {
				if (self.$hoveredElement) {
					self.updateHighlightPosition();
				}
			});
		},

		/**
		 * Highlight element on hover
		 */
		highlightElement: function($element) {
			if (!$element || !$element.length) return;

			this.$hoveredElement = $element;
			this.updateHighlightPosition();
			this.$hoverHighlight.addClass('active');

			// Update panel name
			var elementName = $element.data('usbid') || 'Element';
			this.$hoverHighlight.find('.lew-hover-panel-name').text(elementName);
		},

		/**
		 * Remove highlight
		 */
		removeHighlight: function() {
			this.$hoverHighlight.removeClass('active');
			this.$hoveredElement = null;
		},

		/**
		 * Update highlight position
		 */
		updateHighlightPosition: function() {
			if (!this.$hoveredElement || !this.$hoveredElement.length) return;

			var offset = this.$hoveredElement.offset();
			var width = this.$hoveredElement.outerWidth();
			var height = this.$hoveredElement.outerHeight();

			this.$hoverHighlight.css({
				top: offset.top + 'px',
				left: offset.left + 'px',
				width: width + 'px',
				height: height + 'px'
			});
		},

		/**
		 * Select element
		 */
		selectElement: function($element) {
			if (!$element || !$element.length) return;

			var usbid = $element.data('usbid');

			// Notify parent window
			this.sendMessageToParent('elementSelected', {
				usbid: usbid,
				tagName: $element.prop('tagName'),
				className: $element.attr('class') || '',
				id: $element.attr('id') || ''
			});
		},

		/**
		 * Handle action (copy, paste, duplicate, delete)
		 */
		handleAction: function(action, $element) {
			if (!$element || !$element.length) return;

			var usbid = $element.data('usbid');

			// Notify parent window
			this.sendMessageToParent('elementAction', {
				action: action,
				usbid: usbid
			});
		},

		/**
		 * Send message to parent window
		 */
		sendMessageToParent: function(type, data) {
			if (window.parent && window.parent.$lew) {
				window.parent.$lew.trigger('preview.' + type, [data]);
			}
		},

		/**
		 * Notify parent that preview is loaded
		 */
		notifyParent: function() {
			// Export page data if available
			if (typeof window.lewPageData !== 'undefined') {
				this.sendMessageToParent('pageDataLoaded', window.lewPageData);
			}
		}
	};

	/**
	 * Initialize on document ready
	 */
	$(document).ready(function() {
		LEWPreview.init();
	});

})(jQuery);
